<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Marcinha Semijoias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body class="bg-[#FDFBF7] p-4">
    <header class="max-w-5xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="font-serif text-xl uppercase">Gestão Marcinha</h1>
        <nav class="flex gap-4">
            <button onclick="show('prod')" class="text-[10px] font-bold uppercase border-b-2 border-black">Estoque</button>
            <button onclick="show('conf')" class="text-[10px] font-bold uppercase border-b-2 border-transparent text-gray-400">Ajustes</button>
        </nav>
    </header>

    <main class="max-w-5xl mx-auto">
        <div id="prodSection">
            <form id="productForm" class="bg-white p-6 border mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="editingId">
                <input type="text" id="pSKU" placeholder="SKU" class="border p-3 text-sm uppercase">
                <input type="text" id="pName" placeholder="Nome" class="border p-3 text-sm">
                <input type="number" id="pPrice" placeholder="Preço" step="0.01" class="border p-3 text-sm">
                <input type="number" id="pStock" placeholder="Estoque" class="border p-3 text-sm">
                <input type="file" id="pImageFile" accept="image/*" class="text-xs border p-3 md:col-span-2">
                <select id="pCategory" class="border p-3 text-sm md:col-span-2">
                    <option value="Brincos">Brincos</option>
                    <option value="Colares">Colares</option>
                    <option value="Pulseiras">Pulseiras</option>
                    <option value="Aneis">Aneis</option>
                </select>
                <button type="submit" id="btnSave" class="bg-black text-white p-4 uppercase text-[10px] md:col-span-2">Salvar Produto</button>
            </form>
            <div id="adminProductList" class="space-y-2"></div>
        </div>

        <div id="confSection" class="hidden">
            <form id="configForm" class="bg-white p-6 border space-y-4">
                <input type="text" id="storePhone" placeholder="WhatsApp" class="w-full border p-3">
                <input type="number" id="pixDiscount" placeholder="% Desconto PIX" class="w-full border p-3">
                <input type="number" id="maxInstallments" placeholder="Max Parcelas" class="w-full border p-3">
                <button type="submit" class="w-full bg-[#A68966] text-white p-4 uppercase text-[10px]">Atualizar Configurações</button>
            </form>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD5RdWTYOnaTov7VtM9ZGenUpFYSZVGoPs",
            authDomain: "marcinha-semijoias.firebaseapp.com",
            databaseURL: "https://marcinha-semijoias-default-rtdb.firebaseio.com",
            projectId: "marcinha-semijoias",
            storageBucket: "marcinha-semijoias.firebasestorage.app",
            messagingSenderId: "830107812924",
            appId: "1:830107812924:web:1ee54d9b875514e48eef39"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function show(s) {
            document.getElementById('prodSection').classList.toggle('hidden', s !== 'prod');
            document.getElementById('confSection').classList.toggle('hidden', s !== 'conf');
        }

        async function resizeImage(file) {
            return new Promise((r) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 600; canvas.height = (img.height * 600) / img.width;
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        r(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }

        document.getElementById("productForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("editingId").value;
            const file = document.getElementById("pImageFile").files[0];
            
            let data = {
                sku: document.getElementById("pSKU").value.toUpperCase(),
                name: document.getElementById("pName").value,
                price: parseFloat(document.getElementById("pPrice").value),
                stock: parseInt(document.getElementById("pStock").value),
                category: document.getElementById("pCategory").value
            };

            if(file) data.image = await resizeImage(file);
            else if(id) {
                const current = await db.ref('products/'+id).once('value');
                data.image = current.val().image;
            }

            if(id) db.ref('products/'+id).update(data);
            else db.ref('products').push(data);
            
            e.target.reset();
            document.getElementById("editingId").value = "";
            alert("Pronto!");
        });

        db.ref('products').on('value', snap => {
            const list = document.getElementById("adminProductList");
            list.innerHTML = "";
            const data = snap.val();
            if(data) Object.keys(data).reverse().forEach(id => {
                const p = data[id];
                list.innerHTML += `
                <div class="flex items-center justify-between bg-white p-3 border rounded">
                    <div class="flex items-center gap-3">
                        <img src="${p.image}" class="w-10 h-10 object-cover">
                        <div><p class="text-[10px] font-bold">${p.sku} - ${p.name}</p></div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="editProduct('${id}')" class="text-blue-500 text-[10px] uppercase">Editar</button>
                        <button onclick="db.ref('products/${id}').remove()" class="text-red-300 text-[10px] uppercase">Remover</button>
                    </div>
                </div>`;
            });
        });

        window.editProduct = (id) => {
            db.ref('products/'+id).once('value', s => {
                const p = s.val();
                document.getElementById("editingId").value = id;
                document.getElementById("pSKU").value = p.sku;
                document.getElementById("pName").value = p.name;
                document.getElementById("pPrice").value = p.price;
                document.getElementById("pStock").value = p.stock;
                document.getElementById("pCategory").value = p.category;
                window.scrollTo(0,0);
            });
        }
    </script>
</body>
</html>
