<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Gestão | Marcinha Semijoias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #FDFBF7; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-5xl mx-auto mb-10 border-b pb-6 no-print">
        <h1 class="font-serif text-2xl uppercase tracking-widest text-[#A68966]">Marcinha Semijoias - Admin</h1>
        <p class="text-[9px] text-green-500 font-bold uppercase mt-1">● Sistema Sincronizado</p>
        
        <nav class="flex gap-4 mt-6 overflow-x-auto pb-2">
            <button onclick="openTab('produtos')" class="tab-btn text-[10px] uppercase tracking-widest font-bold border-b-2 border-[#A68966] pb-1">Estoque</button>
            <button onclick="openTab('vendas')" class="tab-btn text-[10px] uppercase tracking-widest font-bold border-b-2 border-transparent pb-1 text-gray-400">Vendas e Pedidos</button>
            <button onclick="openTab('config')" class="tab-btn text-[10px] uppercase tracking-widest font-bold border-b-2 border-transparent pb-1 text-gray-400">Configuração</button>
        </nav>
    </header>

    <main class="max-w-5xl mx-auto">
        
        <div id="produtos" class="tab-content active space-y-8 no-print">
            <section class="bg-white p-6 border border-[#E5E1DB]">
                <h2 id="formTitle" class="font-serif text-lg mb-4 uppercase tracking-tighter">Cadastrar Nova Joia</h2>
                <form id="productForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="editingId">
                    <input type="text" id="pSKU" placeholder="SKU (Ex: BR-001)" class="border p-3 text-sm font-mono uppercase" required>
                    <input type="text" id="pName" placeholder="Nome da Peça" class="border p-3 text-sm" required>
                    <input type="number" id="pPrice" placeholder="Preço" step="0.01" class="border p-3 text-sm" required>
                    <input type="number" id="pStock" placeholder="Qtd Estoque" class="border p-3 text-sm" required>
                    
                    <div class="border p-3 bg-gray-50 rounded md:col-span-2">
                        <label class="text-[9px] uppercase text-gray-400 block mb-1 font-bold">Foto da Joia (Upload)</label>
                        <input type="file" id="pImageFile" accept="image/*" class="text-[10px]">
                        <p id="editImgMsg" class="hidden text-[9px] text-[#A68966] mt-1 italic font-bold">● Mantendo foto atual (escolha uma nova se desejar trocar)</p>
                    </div>

                    <select id="pCategory" class="border p-3 text-sm bg-white md:col-span-2" required>
                        <option value="Brincos">Brincos</option>
                        <option value="Colares">Colares</option>
                        <option value="Pulseiras">Pulseiras</option>
                        <option value="Aneis">Anéis</option>
                    </select>

                    <div class="md:col-span-2 flex gap-2">
                        <button type="submit" id="btnSave" class="flex-1 bg-black text-white py-4 text-[10px] uppercase tracking-widest hover:bg-[#A68966] transition">Salvar Produto</button>
                        <button type="button" onclick="resetForm()" id="btnCancel" class="hidden bg-gray-200 text-gray-600 px-6 text-[10px] uppercase font-bold">Cancelar</button>
                    </div>
                </form>
            </section>
            
            <div id="adminProductList" class="grid grid-cols-1 gap-2"></div>
        </div>

        <div id="vendas" class="tab-content space-y-8">
            <section class="bg-white p-6 border border-[#E5E1DB]">
                <div class="flex justify-between items-center mb-6 border-b pb-4 no-print">
                    <h2 class="font-serif text-lg">Histórico de Vendas</h2>
                    <button onclick="clearOrders()" class="text-[9px] text-red-300 uppercase underline">Limpar Tudo</button>
                </div>
                <div id="ordersList" class="space-y-6">
                    </div>
            </section>
        </div>

        <div id="config" class="tab-content space-y-8 no-print">
            <section class="bg-white p-6 border border-[#E5E1DB]">
                <h2 class="font-serif text-lg mb-4">Dados da Empresa</h2>
                <form id="configForm" class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="text-[10px] uppercase text-gray-400 font-bold">WhatsApp de Vendas</label>
                        <input type="text" id="storePhone" class="w-full border-b p-2 text-sm focus:outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase text-gray-400 font-bold">% Desconto PIX</label>
                        <input type="number" id="pixDiscount" class="w-full border-b p-2 text-sm focus:outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase text-gray-400 font-bold">Parcelas Máximas Cartão</label>
                        <input type="number" id="maxInstallments" class="w-full border-b p-2 text-sm focus:outline-none">
                    </div>
                    <button type="submit" class="bg-[#A68966] text-white py-4 text-[10px] uppercase tracking-widest">Atualizar Loja</button>
                </form>
            </section>
        </div>

    </main>

    <script>
        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD5RdWTYOnaTov7VtM9ZGenUpFYSZVGoPs",
            authDomain: "marcinha-semijoias.firebaseapp.com",
            databaseURL: "https://marcinha-semijoias-default-rtdb.firebaseio.com",
            projectId: "marcinha-semijoias",
            storageBucket: "marcinha-semijoias.firebasestorage.app",
            messagingSenderId: "830107812924",
            appId: "1:830107812924:web:1ee54d9b875514e48eef39"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // NAVEGAÇÃO
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.replace('border-[#A68966]', 'border-transparent');
                btn.classList.replace('text-black', 'text-gray-400');
            });
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.replace('border-transparent', 'border-[#A68966]');
            event.currentTarget.classList.replace('text-gray-400', 'text-black');
        }

        // REDIMENSIONADOR (600px - JPG 0.7)
        async function resizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 600 / img.width;
                        canvas.width = 600;
                        canvas.height = img.height * scale;
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }

        // SALVAR PRODUTO
        document.getElementById("productForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const btn = document.getElementById("btnSave");
            const editingId = document.getElementById("editingId").value;
            const file = document.getElementById("pImageFile").files[0];
            btn.innerText = "PROCESSANDO...";
            btn.disabled = true;

            let data = {
                sku: document.getElementById("pSKU").value.toUpperCase(),
                name: document.getElementById("pName").value,
                price: parseFloat(document.getElementById("pPrice").value),
                stock: parseInt(document.getElementById("pStock").value),
                category: document.getElementById("pCategory").value
            };

            if (file) {
                data.image = await resizeImage(file);
            } else if (editingId) {
                const snap = await db.ref('products/' + editingId).once('value');
                data.image = snap.val().image;
            } else {
                alert("Selecione uma foto!");
                btn.innerText = "Salvar Produto"; btn.disabled = false; return;
            }

            const ref = editingId ? db.ref('products/' + editingId) : db.ref('products');
            const action = editingId ? ref.update(data) : ref.push(data);

            action.then(() => {
                alert(editingId ? "Atualizado!" : "Cadastrado!");
                resetForm();
            });
        });

        // LISTA DE ESTOQUE
        db.ref('products').on('value', snap => {
            const list = document.getElementById("adminProductList");
            list.innerHTML = "";
            const data = snap.val();
            if (data) Object.keys(data).reverse().forEach(id => {
                const p = data[id];
                list.innerHTML += `
                    <div class="flex items-center justify-between bg-white p-3 border rounded">
                        <div class="flex items-center gap-3">
                            <img src="${p.image}" class="w-10 h-10 object-cover rounded">
                            <div>
                                <p class="text-[9px] font-bold text-[#A68966] uppercase">${p.sku}</p>
                                <p class="text-[10px] font-bold uppercase">${p.name}</p>
                                <p class="text-[8px] text-gray-400">R$ ${p.price.toFixed(2)} | Est: ${p.stock}</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="prepareEdit('${id}')" class="text-blue-500 text-[10px] font-bold uppercase">Editar</button>
                            <button onclick="deleteProduct('${id}')" class="text-red-300 text-[10px] font-bold uppercase">Remover</button>
                        </div>
                    </div>`;
            });
        });

        window.prepareEdit = (id) => {
            db.ref('products/' + id).once('value', s => {
                const p = s.val();
                document.getElementById("editingId").value = id;
                document.getElementById("pSKU").value = p.sku;
                document.getElementById("pName").value = p.name;
                document.getElementById("pPrice").value = p.price;
                document.getElementById("pStock").value = p.stock;
                document.getElementById("pCategory").value = p.category;
                document.getElementById("formTitle").innerText = "Editando: " + p.sku;
                document.getElementById("btnSave").innerText = "Atualizar Peça";
                document.getElementById("btnCancel").classList.remove('hidden');
                document.getElementById("editImgMsg").classList.remove('hidden');
                window.scrollTo(0,0);
            });
        };

        function resetForm() {
            document.getElementById("productForm").reset();
            document.getElementById("editingId").value = "";
            document.getElementById("formTitle").innerText = "Cadastrar Nova Joia";
            document.getElementById("btnSave").innerText = "Salvar Produto";
            document.getElementById("btnSave").disabled = false;
            document.getElementById("btnCancel").classList.add('hidden');
            document.getElementById("editImgMsg").classList.add('hidden');
        }

        function deleteProduct(id) { if(confirm("Apagar produto?")) db.ref('products/'+id).remove(); }

        // ABA VENDAS E IMPRESSÃO
        db.ref('orders').on('value', snap => {
            const list = document.getElementById("ordersList");
            const data = snap.val();
            list.innerHTML = "";
            if (data) Object.keys(data).reverse().forEach(id => {
                const o = data[id];
                list.innerHTML += `
                    <div class="p-6 border bg-white rounded-lg shadow-sm" id="order-${id}">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-[9px] font-bold text-[#A68966] uppercase">${o.date}</p>
                                <h4 class="text-sm font-bold uppercase">${o.customerName}</h4>
                            </div>
                            <button onclick="printOrder('${id}')" class="no-print bg-black text-white text-[9px] px-3 py-1 rounded uppercase font-bold">Imprimir</button>
                        </div>
                        <div class="text-[10px] text-gray-500 border-y py-4 my-2 leading-relaxed">
                            ${o.items}
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-400">Total Pago via WhatsApp</p>
                            <p class="text-sm font-bold">R$ ${o.total}</p>
                        </div>
                    </div>`;
            });
            else list.innerHTML = "<p class='text-xs text-gray-400 text-center py-10'>Nenhum pedido registrado.</p>";
        });

        function printOrder(id) {
            const content = document.getElementById(`order-${id}`).cloneNode(true);
            content.querySelector('button').remove(); // Remove o botão da impressão
            const win = window.open('', '', 'height=700,width=900');
            win.document.write(`<html><head><title>Pedido Marcinha</title><style>
                body { font-family: sans-serif; padding: 40px; }
                .header { text-align: center; border-bottom: 2px solid #A68966; margin-bottom: 20px; padding-bottom: 10px; }
                .footer { text-align: center; margin-top: 40px; font-size: 10px; color: #888; }
                h1 { margin: 0; font-size: 18px; text-transform: uppercase; letter-spacing: 2px; }
            </style></head><body>
                <div class="header"><h1>Marcinha Semijoias</h1><p>Relatório de Pedido</p></div>
                ${content.innerHTML}
                <div class="footer">Obrigada pela preferência! | Instagram: @marcinhasemijoias</div>
            </body></html>`);
            win.document.close();
            setTimeout(() => { win.print(); win.close(); }, 500);
        }

        function clearOrders() { if(confirm("Limpar todo o histórico?")) db.ref('orders').remove(); }

        // CONFIGURAÇÕES
        db.ref('settings').on('value', s => {
            const v = s.val();
            if(v) {
                document.getElementById('storePhone').value = v.phone || "";
                document.getElementById('pixDiscount').value = v.pixDiscount || "";
                document.getElementById('maxInstallments').value = v.installments || "";
            }
        });

        document.getElementById("configForm").addEventListener("submit", (e) => {
            e.preventDefault();
            db.ref('settings').set({
                phone: document.getElementById('storePhone').value,
                pixDiscount: document.getElementById('pixDiscount').value,
                installments: document.getElementById('maxInstallments').value
            }).then(() => alert("Ajustes salvos com sucesso!"));
        });
    </script>
</body>
</html>
