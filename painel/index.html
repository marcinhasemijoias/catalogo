<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo ‚Ä¢ Marcinha Semijoias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        body { background:#0b0b0b; color:#eee; font-family:Inter,Arial; margin:0; }
        nav button.active { border-bottom:2px solid #caa85c; color:#caa85c; }
        section { display:none; min-height:300px; }
        section.active { display:block; }
        .card { background:#141414; border:1px solid #2a2a2a; border-radius:16px; padding:14px; }
        .btn { background:#222; border:1px solid #444; padding:8px 12px; border-radius:8px; font-size:11px; cursor:pointer; transition: 0.3s; }
        .btn:hover { background:#333; }
        .btn-gold { background:#caa85c; color:#000; font-weight:700; padding:10px; border-radius:8px; cursor:pointer; }
        input, select { background:#111; border:1px solid #333; padding:8px; border-radius:8px; width:100%; margin-bottom:8px; color:#fff; outline:none; }
        #mainModal.active { display: flex; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #caa85c; border-radius: 10px; }
        
        #print-area { display: none; }
@media print {
    @page { size: A4; margin: 10mm; }
    body * { visibility: hidden; }
    #print-area, #print-area * { visibility: visible; }
    #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block; background: #fff; color: #000; }
    
    /* Cabe√ßalho Luxo */
    .header-luxo { text-align: center; border-bottom: 2px solid #d4af37; padding-bottom: 10px; margin-bottom: 20px; }
    .header-luxo h1 { font-size: 35px; letter-spacing: 5px; margin: 0; font-weight: 900; }

    /* Boxes Luxuosos */
    .caixa-dados { width: 100%; border-collapse: separate; border-spacing: 10px 0; margin-bottom: 15px; }
    .caixa-dados td { 
        border: 1.5px solid #d4af37; padding: 12px; vertical-align: top; width: 50%; font-size: 11px; 
        border-radius: 10px; position: relative;
    }
    .titulo-box { 
        position: absolute; top: -9px; left: 10px; background: #fff; padding: 0 5px;
        font-weight: bold; text-transform: uppercase; font-size: 9px; color: #d4af37;
    }

    /* Layout Grid */
    .grid-romaneio { display: grid; grid-template-columns: repeat(4, 1fr); border-top: 1px solid #000; border-left: 1px solid #000; }
    .grid-item { border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 5px; text-align: center; font-size: 10px; }
    .grid-item img { max-width: 80px; max-height: 80px; object-fit: contain; margin-bottom: 5px; }

    /* Layout Tabela */
    .tab-romaneio { width: 100%; border-collapse: collapse; font-size: 11px; }
    .tab-romaneio th, .tab-romaneio td { border: 1px solid #000; padding: 5px; text-align: left; }
    .tab-romaneio th { background: #f2f2f2; font-size: 10px; text-transform: uppercase; }
}
</style>
</head>
<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222] text-[#caa85c] tracking-widest uppercase">
    Marcinha Semijoias ‚Ä¢ Gest√£o Total
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
    <button type="button" class="btn active" onclick="showTab('empresa', this)">Empresa</button>
    <button type="button" class="btn" onclick="showTab('categorias', this)">Categorias</button>
    <button type="button" class="btn" onclick="showTab('produtos', this)">Produtos</button>
    <button type="button" class="btn" onclick="showTab('promocoes', this)">Promo√ß√µes</button>
    <button type="button" class="btn" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-6 max-w-4xl mx-auto">
    <section id="empresa" class="active">
        <div class="card space-y-3">
            <h2 class="text-[#caa85c] font-bold uppercase text-sm">Configura√ß√£o da Loja</h2>
            <input id="empNome" placeholder="Nome da Empresa">
            <input id="empSub" placeholder="Slogan / Subt√≠tulo">
            <input id="empWhats" placeholder="WhatsApp da Loja">
            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-[10px] text-gray-400">DESC. PIX %</label><input id="empDesc" type="number"></div>
                <div><label class="text-[10px] text-gray-400">PARCELAS M√ÅX</label><input id="empParc" type="number"></div>
            </div>
            <button class="btn-gold w-full" onclick="salvarEmpresa()">GUARDAR ALTERA√á√ïES</button>
        </div>
    </section>

    <section id="categorias">
        <div class="card mb-4">
            <input id="newCatName" placeholder="Nome da Nova Categoria">
            <button class="btn-gold w-full" onclick="novaCategoria()">+ CADASTRAR CATEGORIA</button>
        </div>
        <div id="listaCategorias" class="grid gap-2"></div>
    </section>

    <section id="produtos">
        <div id="listaProdutos" class="grid gap-2"></div>
    </section>

    <section id="promocoes">
        <div class="card mb-4 text-center">
            <h2 class="text-[#caa85c] font-bold uppercase text-sm mb-4 tracking-widest">Painel de Ofertas</h2>
            <button class="btn-gold w-full py-4 uppercase" onclick="abrirPainelPromocoes()">
                üé® Configurar Descontos por Categoria
            </button>
        </div>
    </section>

    <section id="pedidos">
        <div id="listaPedidos" class="grid gap-4"></div>
    </section>
</main>

<div id="mainModal" class="fixed inset-0 bg-black/90 z-[100] hidden items-center justify-center p-4">
    <div class="bg-[#141414] border border-[#2a2a2a] w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl">
        <div class="p-4 border-b border-[#222] flex justify-between items-center">
            <h3 id="modalTitle" class="text-[#caa85c] font-bold uppercase text-sm">T√≠tulo</h3>
            <button onclick="fecharModal()" class="text-gray-500 hover:text-white text-2xl">&times;</button>
        </div>
        <div id="modalBody" class="p-6 max-h-[70vh] overflow-y-auto"></div>
        <div class="p-4 border-t border-[#222] flex gap-3">
            <button onclick="fecharModal()" class="flex-1 py-3 text-xs uppercase font-bold text-gray-500">Cancelar</button>
            <button id="modalSaveBtn" class="flex-1 btn-gold py-3 text-xs uppercase font-bold">Salvar</button>
        </div>
    </div>
</div>

<div id="editorPedido" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
  <div class="bg-[#111] w-full max-w-4xl rounded-2xl p-5 overflow-auto max-h-[95vh] border border-[#333] custom-scroll">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-[#caa85c] font-bold text-lg uppercase">Editar Pedido</h2>
        <div id="totalPreview" class="text-right text-[#caa85c] font-bold text-xl">R$ 0,00</div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h3 class="font-bold mb-2 text-[10px] text-gray-400 uppercase">Dados do Cliente</h3>
        <input id="edClienteNome" placeholder="Nome">
        <input id="edClienteTel" placeholder="WhatsApp">
      </div>
<div class="card">
        <h3 class="font-bold mb-2 text-[10px] text-gray-400 uppercase font-bold tracking-widest">Endere√ßo de Entrega</h3>
        <input id="edNomeEntrega" placeholder="Nome do Destinat√°rio (Quem recebe)">
        <input id="edRua" placeholder="Rua e N√∫mero">
        <div class="grid grid-cols-2 gap-2">
            <input id="edBairro" placeholder="Bairro">
            <input id="edCidade" placeholder="Cidade">
        </div>
      </div>
    </div>

    <h3 class="font-bold mt-4 mb-2 text-xs text-[#caa85c] uppercase">Itens da Compra</h3>
    <div id="edItens" class="space-y-2"></div>
    <button class="btn w-full mt-2 border-dashed border-gray-600 text-gray-400" onclick="addItemEditor()">+ ADICIONAR ITEM MANUAL</button>

    <div class="grid grid-cols-3 gap-3 mt-6 p-4 bg-black/40 rounded-xl">
        <div><label class="text-[9px] text-gray-500">DESC. PROMO (R$)</label><input id="edDescPromo" type="number" step="0.01" oninput="recalcularTotalEd()"></div>
        <div><label class="text-[9px] text-gray-500">DESC. PIX (R$)</label><input id="edDescPix" type="number" step="0.01" oninput="recalcularTotalEd()"></div>
        <div><label class="text-[9px] text-gray-500">FRETE (R$)</label><input id="edFrete" type="number" step="0.01" oninput="recalcularTotalEd()"></div>
    </div>

<div class="mt-6 pt-4 border-t border-[#222]">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
        <button class="btn bg-gray-800 border-gray-700 hover:bg-gray-700 text-[9px] py-3" onclick="imprimirRomaneio(pedidoEditando, 1)">1. CONFER√äNCIA (TAB)</button>
        <button class="btn bg-gray-800 border-gray-700 hover:bg-gray-700 text-[9px] py-3" onclick="imprimirRomaneio(pedidoEditando, 2)">2. FINANCEIRO (TAB)</button>
        <button class="btn bg-gray-800 border-gray-700 hover:bg-gray-700 text-[9px] py-3" onclick="imprimirRomaneio(pedidoEditando, 3)">3. FOTOS (TAB)</button>
        
        <button class="btn bg-blue-900 border-blue-700 hover:bg-blue-800 text-[9px] py-3" onclick="imprimirRomaneio(pedidoEditando, 4)">4. CONFER√äNCIA (GRID)</button>
        <button class="btn bg-blue-900 border-blue-700 hover:bg-blue-800 text-[9px] py-3" onclick="imprimirRomaneio(pedidoEditando, 5)">5. FINANCEIRO (GRID)</button>
        <button class="btn bg-blue-900 border-blue-700 hover:bg-blue-800 text-[9px] py-3" onclick="imprimirRomaneio(pedidoEditando, 6)">6. FOTOS (GRID)</button>
      </div>

      <div class="flex flex-wrap gap-2 justify-between">
        <button class="btn px-8 border-red-900/50 text-red-400" onclick="fecharEditorPedido()">SAIR</button>
        <button class="btn-gold px-12" onclick="salvarPedidoEditado()">SALVAR ALTERA√á√ïES</button>
      </div>
    </div>
  </div>
</div>

<div id="print-area"></div>
<script>
/* ============================
   FIREBASE ‚Ä¢ MARCINHA SEMIJOIAS
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyAQMdBkCMssdrtM4q3btyTrVyO940WkJK0",
  authDomain: "marcinha-semijoias-ee0c0.firebaseapp.com",
  databaseURL: "https://marcinha-semijoias-ee0c0-default-rtdb.firebaseio.com",
  projectId: "marcinha-semijoias-ee0c0",
  storageBucket: "marcinha-semijoias-ee0c0.firebasestorage.app",
  messagingSenderId: "846120624573",
  appId: "1:846120624573:web:7aa82e2a3df66c2e7d32d4",
  measurementId: "G-WY7Q8CF754"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let pedidoEditando = null;
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
const fPeso = g => (Number(g) || 0).toLocaleString('pt-BR') + ' g';

/* NAVEGA√á√ÉO */
function showTab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    if (id === 'categorias') carregarCategorias();
    if (id === 'produtos') carregarProdutos();
    if (id === 'pedidos') carregarPedidos();
    if (id === 'empresa') carregarEmpresa();
}

/* EMPRESA */
function carregarEmpresa() {
    db.ref('settings/empresa').once('value', s => {
        const v = s.val() || {};
        document.getElementById('empNome').value = v.nome || '';
        document.getElementById('empSub').value = v.subtitulo || '';
        document.getElementById('empWhats').value = v.whats || '';
        document.getElementById('empDesc').value = v.descontoPix || 0;
        document.getElementById('empParc').value = v.parcelas || 0;
    });
}
function salvarEmpresa() {
    db.ref('settings/empresa').update({
        nome: document.getElementById('empNome').value,
        subtitulo: document.getElementById('empSub').value,
        whats: document.getElementById('empWhats').value,
        descontoPix: +document.getElementById('empDesc').value,
        parcelas: +document.getElementById('empParc').value
    }).then(() => alert('Configura√ß√µes atualizadas!'));
}

/* CATEGORIAS & PRODUTOS */
function carregarCategorias() {
    db.ref('categories').on('value', s => {
        const lista = document.getElementById('listaCategorias');
        lista.innerHTML = '';
        s.forEach(c => {
            lista.innerHTML += `<div class="card flex justify-between items-center">
                <span class="uppercase text-xs font-bold">${c.val().name}</span>
                <div class="flex gap-2">
                    <button class="btn text-blue-400" onclick="editarCat('${c.key}','${c.val().name}')">‚úé</button>
                    <button class="btn text-red-500" onclick="excluirCat('${c.key}')">üóë</button>
                </div>
            </div>`;
        });
    });
}
function novaCategoria() {
    const n = document.getElementById('newCatName').value;
    if(n) db.ref('categories').push({name:n}).then(() => document.getElementById('newCatName').value = '');
}
function excluirCat(id) { if(confirm("Excluir categoria?")) db.ref('categories/'+id).remove(); }

function carregarProdutos() {
    const lista = document.getElementById('listaProdutos');
    lista.innerHTML = '<p class="text-center p-4">Carregando...</p>';
    db.ref('categories').once('value', sCats => {
        db.ref('products').once('value', sProds => {
            lista.innerHTML = '';
            sCats.forEach(cat => {
                let htmlP = '';
                sProds.forEach(p => {
                    const prod = p.val();
                    if(prod.category === cat.key) {
                        htmlP += `<div class="card flex justify-between items-center py-2 px-3 bg-[#0d0d0d] mb-1 text-[11px]">
                            <div class="flex items-center gap-3">
                                <img src="${prod.image || ''}" class="w-8 h-8 object-cover rounded border border-[#333]">
                                <span><b class="text-[#caa85c]">[${prod.sku || '---'}]</b> ${prod.name}</span>
                            </div>
                            <button onclick="editarProduto('${p.key}')">‚úé</button>
                        </div>`;
                    }
                });
                if(htmlP) lista.innerHTML += `<div class="mb-4"><b class="text-[10px] text-[#caa85c] ml-1 uppercase">${cat.val().name}</b><div class="mt-1">${htmlP}</div></div>`;
            });
        });
    });
}

function editarProduto(id) {
    db.ref('products/'+id).once('value', s => {
        const p = s.val();
        const nNome = prompt("Nome:", p.name);
        const nPreco = prompt("Pre√ßo:", p.price);
        const nSku = prompt("SKU:", p.sku);
        const nPeso = prompt("Peso (g):", p.peso || p.weight || 0);
        if(nNome) db.ref('products/'+id).update({ name:nNome, price:Number(nPreco), sku:nSku, peso:Number(nPeso) }).then(carregarProdutos);
    });
}

/* PEDIDOS */
function carregarPedidos() {
    db.ref('orders').on('value', s => {
        const lista = document.getElementById('listaPedidos');
        lista.innerHTML = '';
        s.forEach(ped => {
            const p = ped.val();
            lista.innerHTML += `<div class="card border-l-4 border-[#caa85c]">
                <div class="flex justify-between items-start">
                    <div>
                        <b class="text-[#caa85c] uppercase text-sm">${p.cliente?.nome || 'Cliente'}</b><br>
                        <small class="text-gray-500">${p.data || ''} | ${p.itens ? (Array.isArray(p.itens) ? p.itens.length : Object.keys(p.itens).length) : 0} itens</small>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-xs">${fMoeda(p.total)}</div>
                        <div class="flex gap-1 mt-2">
                             <button class="btn p-1 bg-blue-900" onclick="duplicarPedido('${ped.key}')" title="Duplicar">üìë</button>
                             <button class="btn p-1" onclick="abrirEditorPedido('${ped.key}')">EDITAR</button>
                             <button class="btn p-1 bg-red-900" onclick="excluirPedido('${ped.key}')">üóë</button>
                        </div>
                    </div>
                </div>
            </div>`;
        });
    });
}

function abrirEditorPedido(id) {
    pedidoEditando = id;
    db.ref('orders/'+id).once('value', s => {
        const p = s.val();
        document.getElementById('edClienteNome').value = p.cliente?.nome || '';
        document.getElementById('edClienteTel').value = p.cliente?.telefone || '';
        document.getElementById('edNomeEntrega').value = p.entrega?.nomeEntrega || '';
        document.getElementById('edRua').value = p.entrega?.rua || '';
        document.getElementById('edBairro').value = p.entrega?.bairro || '';
        document.getElementById('edCidade').value = p.entrega?.cidade || '';
        document.getElementById('edDescPromo').value = p.descontoPromo || 0;
        document.getElementById('edDescPix').value = p.descontoPix || 0;
        document.getElementById('edFrete').value = p.frete || 0;
        document.getElementById('edItens').innerHTML = '';
        const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
        itens.forEach(addItemEditor);
        recalcularTotalEd();
        document.getElementById('editorPedido').classList.remove('hidden');

    });
}

function addItemEditor(i={}) {
    const div = document.createElement('div');
    div.className = "card bg-black/40 border-[#222] mb-2 p-2";
    div.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
            <input placeholder="SKU" value="${i.sku||''}" class="!mb-0 text-[10px]">
            <input placeholder="Nome" value="${i.name||''}" class="!mb-0 text-[10px]">
            <input type="number" placeholder="Peso" value="${i.peso||i.weight||0}" class="!mb-0 text-[10px]" oninput="recalcularTotalEd()">
            <input type="number" placeholder="Pre√ßo" value="${i.price||i.precoFinal||0}" class="!mb-0 text-[10px]" oninput="recalcularTotalEd()">
            <input type="number" placeholder="Qtd" value="${i.quantidade||i.qtd||1}" class="!mb-0 text-[10px]" oninput="recalcularTotalEd()">
        </div>
        <button class="text-red-500 text-[9px] uppercase font-bold mt-1" onclick="this.parentElement.remove();recalcularTotalEd();">Remover Item</button>`;
    document.getElementById('edItens').appendChild(div);
}

function recalcularTotalEd() {
    let subtotal = 0;
    document.querySelectorAll('#edItens > div').forEach(div => {
        const inputs = div.querySelectorAll('input');
        const preco = Number(inputs[3].value) || 0;
        const qtd = Number(inputs[4].value) || 0;
        subtotal += (preco * qtd);
    });
    const descP = Number(document.getElementById('edDescPromo').value) || 0;
    const descX = Number(document.getElementById('edDescPix').value) || 0;
    const frete = Number(document.getElementById('edFrete').value) || 0;
    const total = subtotal - descP - descX + frete;
    document.getElementById('totalPreview').innerText = fMoeda(total);
}

function salvarPedidoEditado() {
    const itens = [];
    let subtotal = 0, pesoTotal = 0, totalPecas = 0;
    document.querySelectorAll('#edItens > div').forEach(div => {
        const ins = div.querySelectorAll('input');
        const item = { sku: ins[0].value, name: ins[1].value, peso: Number(ins[2].value), price: Number(ins[3].value), quantidade: Number(ins[4].value) };
        subtotal += (item.price * item.quantidade);
        pesoTotal += (item.peso * item.quantidade);
        totalPecas += item.quantidade;
        itens.push(item);
    });
    const dPromo = Number(document.getElementById('edDescPromo').value);
    const dPix = Number(document.getElementById('edDescPix').value);
    const frete = Number(document.getElementById('edFrete').value);

    db.ref('orders/'+pedidoEditando).update({
        cliente: { 
            nome: document.getElementById('edClienteNome').value, 
            telefone: document.getElementById('edClienteTel').value 
        },
        entrega: { 
            nomeEntrega: document.getElementById('edNomeEntrega').value, // NOVO CAMPO
            rua: document.getElementById('edRua').value, 
            bairro: document.getElementById('edBairro').value, 
            cidade: document.getElementById('edCidade').value 
        },
        itens, 
        subtotal, 
        pesoTotal, 
        totalPecas, 
        descontoPromo: dPromo, 
        descontoPix: dPix, 
        frete, 
        total: (subtotal - dPromo - dPix + frete)
    }).then(() => { 
        alert("Pedido Salvo com Sucesso!"); 
        fecharEditorPedido(); 
    });
}

function duplicarPedido(id) {
    if(!confirm("Duplicar este pedido?")) return;
    db.ref('orders/'+id).once('value', s => {
        const novo = s.val();
        novo.data = new Date().toLocaleString();
        db.ref('orders').push(novo).then(() => alert("Pedido duplicado!"));
    });
}

function excluirPedido(id) { if(confirm("Excluir pedido permanentemente?")) db.ref('orders/'+id).remove(); }
function fecharEditorPedido() { document.getElementById('editorPedido').classList.add('hidden'); }
function fecharModal() { document.getElementById('mainModal').classList.remove('active'); }

/* IMPRESS√ÉO ROMANEIO ATUALIZADA - MARCINHA - SEMIJOIAS */
function imprimirRomaneio(id, tipo) {
    db.ref('orders/' + id).once('value', sPed => {
        const p = sPed.val();
        if (!p) return alert("Pedido n√£o encontrado!");

        db.ref('settings/empresa').once('value', sEmp => {
            const emp = sEmp.val() || { nome: "Marcinha", whats: "---" };
            const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
            
            const isFin = [2, 3, 5, 6].includes(tipo); 
            const comFoto = [3, 6].includes(tipo);    
            const emGrid = tipo >= 4;                  

            const subtotal = itens.reduce((acc, i) => acc + ((Number(i.price) || 0) * (Number(i.quantidade) || 0)), 0);
            const descPromo = Number(p.descontoPromo || 0);
            const descPix = Number(p.descontoPix || 0);
            const frete = Number(p.frete || 0);
            const totalFinal = subtotal - descPromo - descPix + frete;

            let html = `
            <div style="padding:8mm; font-family:Arial, sans-serif; color:#000; background:#fff;">
                <div style="text-align:center; border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 15px;">
                    <h1 style="margin:0; font-size:22px; text-transform:uppercase; letter-spacing:3px;">${emp.nome}</h1>
                    <div style="font-size:9px; font-weight:bold; color: #444;">SEMIJOIAS | ${emp.whats}</div>
                </div>

                <table style="width:100%; border-collapse: separate; border-spacing: 5px 0; margin-bottom:15px;">
                    <tr>
                        <td style="width:50%; border: 1px solid #ccc; border-radius: 8px; padding:8px; vertical-align:top; font-size:10px; line-height:1.2;">
                            <b style="color:#caa85c; font-size:8px; text-transform:uppercase;">Identifica√ß√£o Cliente</b><br>
                            <b>${p.cliente?.nome || '---'}</b><br>
                            ${p.cliente?.telefone || '---'}
                        </td>
                        <td style="width:50%; border: 1px solid #ccc; border-radius: 8px; padding:8px; vertical-align:top; font-size:10px; line-height:1.2;">
                            <b style="color:#caa85c; font-size:8px; text-transform:uppercase;">Dados de Entrega</b><br>
                            <b>${p.entrega?.nomeEntrega || p.cliente?.nome}</b><br>
                            ${p.entrega?.rua || ''} - ${p.entrega?.bairro || ''}<br>${p.entrega?.cidade || ''}
                        </td>
                    </tr>
                </table>`;

            if (emGrid) {
                // MODELO GRID (MOLDURAS E CANTOS ARREDONDADOS)
                html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">`;
                itens.forEach(i => {
                    html += `
                    <div style="border: 1px solid #ddd; border-radius: 10px; padding: 8px; background:#fff; display: flex; flex-direction: column; justify-content: space-between; page-break-inside: avoid;">
                        <div>
                            ${comFoto ? `<img src="${i.image || ''}" style="width: 100%; height: 80px; object-fit: contain; margin-bottom: 5px; border-radius: 5px;">` : ''}
                            <div style="font-size: 10px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 2px;">${i.sku || 'S/SKU'}</div>
                            <div style="font-size: 9px; color: #333; text-transform: uppercase; margin-top: 3px; line-height:1.1;">${i.name || ''}</div>
                            <div style="font-size: 8px; color: #777; margin-top: 2px;">Peso U: <b>${(i.peso || 0).toFixed(2)}g</b></div>
                        </div>
                        <div style="margin-top: 6px; background: #f4f4f4; padding: 4px; border-radius: 6px; display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size: 9px; font-weight: bold;">QTD: ${i.quantidade}</span>
                            ${isFin ? `<span style="font-size: 10px; font-weight: bold; color:#96793a;">${fMoeda(i.price * i.quantidade)}</span>` : ''}
                        </div>
                    </div>`;
                });
                html += `</div>`;
            } else {
                // MODELO TABELA (MAIS COMPACTO - VERS√ÉO ANTERIOR)
                html += `
                <table style="width:100%; border-collapse:collapse; font-size:10px;">
                    <thead style="background:#eee;">
                        <tr>
                            ${comFoto ? '<th style="padding:4px; border:1px solid #ccc; width:50px;">Foto</th>' : ''}
                            <th style="padding:4px; border:1px solid #ccc; text-align:left;">Produto / SKU</th>
                            <th style="padding:4px; border:1px solid #ccc; text-align:center; width:60px;">Peso U.</th>
                            <th style="padding:4px; border:1px solid #ccc; text-align:center; width:40px;">Qtd</th>
                            ${isFin ? '<th style="padding:4px; border:1px solid #ccc; text-align:right; width:80px;">Subtotal</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>`;
                itens.forEach(i => {
                    html += `<tr>
                        ${comFoto ? `<td style="padding:2px; border:1px solid #ccc; text-align:center;"><img src="${i.image || ''}" style="width:35px; height:35px; object-fit:contain;"></td>` : ''}
                        <td style="padding:4px; border:1px solid #ccc;"><b>${i.sku}</b> - ${i.name}</td>
                        <td style="padding:4px; border:1px solid #ccc; text-align:center;">${(i.peso || 0).toFixed(2)}g</td>
                        <td style="padding:4px; border:1px solid #ccc; text-align:center;"><b>${i.quantidade}</b></td>
                        ${isFin ? `<td style="padding:4px; border:1px solid #ccc; text-align:right;">${fMoeda(i.price * i.quantidade)}</td>` : ''}
                    </tr>`;
                });
                html += `</tbody></table>`;
            }

            // --- RESUMO FINANCEIRO ORGANIZADO ---
            html += `
            <div style="margin-top: 15px; border: 1.5px solid #caa85c; border-radius: 10px; padding: 12px; background: #fff; page-break-inside: avoid;">
                <div style="display: flex; justify-content: space-between;">
                    
                    <div style="font-size: 10px; line-height: 1.5; width: 45%;">
                        <b style="color:#caa85c; font-size:11px; text-transform:uppercase;">Resumo da Mercadoria</b><br>
                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:2px 0;"><span>Modelos:</span> <b>${itens.length}</b></div>
                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:2px 0;"><span>Total de Pe√ßas:</span> <b>${p.totalPecas || 0}</b></div>
                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:2px 0;"><span>Peso Total:</span> <b>${(p.pesoTotal || 0).toFixed(2)}g</b></div>
                        <div style="margin-top:5px;"><b>Pagamento:</b> ${p.pagamento || 'A definir'}</div>
                    </div>

                    <div style="width: 50%; text-align: right;">
                        ${isFin ? `
                            <table style="width:100%; font-size:10px; border-collapse:collapse;">
                                <tr><td style="text-align:right; padding:2px;">Subtotal Itens:</td><td style="width:80px;">${fMoeda(subtotal)}</td></tr>
                                <tr><td style="text-align:right; padding:2px;">Desconto Promocional:</td><td style="color:red;">-${fMoeda(descPromo)}</td></tr>
                                <tr><td style="text-align:right; padding:2px;">Desconto PIX:</td><td style="color:red;">-${fMoeda(descPix)}</td></tr>
                                <tr><td style="text-align:right; padding:2px;">Frete/Envio:</td><td>${fMoeda(frete)}</td></tr>
                                <tr>
                                    <td style="text-align:right; padding:5px 2px; font-weight:bold; font-size:12px;">TOTAL DO PEDIDO:</td>
                                    <td style="padding:5px 0; font-weight:bold; font-size:16px; border-top:1px solid #000;">${fMoeda(totalFinal)}</td>
                                </tr>
                            </table>
                        ` : `
                            <div style="height:100%; display:flex; align-items:center; justify-content:flex-end;">
                                <span style="font-size:14px; font-weight:bold; color:#caa85c;">ROMANEIO DE CONFER√äNCIA</span>
                            </div>
                        `}
                    </div>

                </div>
            </div>
            </div>`;

            const area = document.getElementById('print-area');
            area.innerHTML = html;
            setTimeout(() => { window.print(); }, 700);
        });
    });
}
/* PROMO√á√ïES COMPLETO COM COR DE TEXTO E CAMPANHA PERSONALIZADA */
async function abrirPainelPromocoes() {
    try {
        const [snapPromo, snapCats] = await Promise.all([
            db.ref('settings/promocao').once('value'), 
            db.ref('categories').once('value')
        ]);
        
        const promoGeral = snapPromo.val() || { ativa: false };
        let listaCats = '';

        snapCats.forEach(cat => {
            const c = cat.val();
            // Carrega os dados salvos ou define valores padr√£o para evitar campos vazios
            const pct = c.promoPct || 0;
            const nomePromo = c.promoName || '';
            const tagColor = c.promoColor || '#caa85c';
            const textColor = c.promoTextColor || '#ffffff';
            const tagText = c.promoTag || 'OFERTA';

            listaCats += `
            <div class="card bg-black/40 p-3 mb-3 border border-[#222]">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs uppercase font-black text-[#caa85c]">${c.name}</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="col-span-2">
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Nome da Campanha (Ex: Queima Total)</label>
                        <input type="text" id="p_name_${cat.key}" value="${nomePromo}" placeholder="Substitua o Carnaval de Ofertas aqui" class="!mb-1 !p-1 text-xs bg-black border border-[#333] w-full rounded">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Texto da Tag</label>
                        <input type="text" id="p_tag_${cat.key}" value="${tagText}" placeholder="Ex: 20% OFF" class="!mb-1 !p-1 text-xs bg-black border border-[#333] w-full rounded">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold">Desconto (%)</label>
                        <input type="number" id="p_pct_${cat.key}" value="${pct}" class="!mb-1 !p-1 text-xs bg-black border border-[#333] w-full rounded">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold text-center block">Fundo Tag</label>
                        <input type="color" id="p_color_${cat.key}" value="${tagColor}" class="!h-8 !p-0 border-none cursor-pointer w-full bg-transparent">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold text-center block">Texto Tag</label>
                        <input type="color" id="p_tcolor_${cat.key}" value="${textColor}" class="!h-8 !p-0 border-none cursor-pointer w-full bg-transparent">
                    </div>
                </div>
            </div>`;
        });

        const html = `
        <div class="space-y-4">
            <div class="flex justify-between items-center bg-[#1a1a1a] p-3 rounded-xl border border-[#333]">
                <div>
                    <span class="text-sm font-bold block">Status da Promo√ß√£o</span>
                    <small class="text-[9px] text-gray-400 uppercase">Ativar selos no cat√°logo</small>
                </div>
                <button onclick="togglePromoStatus()" id="btnStatusPromo" 
                    class="px-6 py-2 rounded-lg text-[10px] font-bold transition-all ${promoGeral.ativa ? 'bg-green-600' : 'bg-red-600'}">
                    ${promoGeral.ativa ? 'ATIVA' : 'INATIVA'}
                </button>
            </div>
            <div class="max-h-[50vh] overflow-y-auto custom-scroll pr-2">
                ${listaCats}
            </div>
        </div>`;

        document.getElementById('modalTitle').innerText = 'üé® CONFIGURAR OFERTAS POR CATEGORIA';
        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('mainModal').classList.add('active');

        // L√ìGICA DE SALVAMENTO
        document.getElementById('modalSaveBtn').onclick = () => {
            const updates = {};
            updates['settings/promocao/ativa'] = document.getElementById('btnStatusPromo').innerText === 'ATIVA';
            
            snapCats.forEach(cat => {
                updates['categories/' + cat.key + '/promoPct'] = +document.getElementById('p_pct_' + cat.key).value || 0;
                updates['categories/' + cat.key + '/promoName'] = document.getElementById('p_name_' + cat.key).value;
                updates['categories/' + cat.key + '/promoTag'] = document.getElementById('p_tag_' + cat.key).value;
                updates['categories/' + cat.key + '/promoColor'] = document.getElementById('p_color_' + cat.key).value;
                updates['categories/' + cat.key + '/promoTextColor'] = document.getElementById('p_tcolor_' + cat.key).value;
            });

            db.ref().update(updates).then(() => {
                alert("Promo√ß√µes salvas com sucesso!");
                fecharModal();
            }).catch(err => {
                console.error(err);
                alert("Erro ao salvar promo√ß√µes.");
            });
        };
    } catch (error) {
        console.error("Erro ao abrir painel:", error);
        alert("Erro ao carregar promo√ß√µes. Verifique o console.");
    }
}

function togglePromoStatus() {
    const btn = document.getElementById('btnStatusPromo');
    const isAtiva = btn.innerText === 'ATIVA';
    btn.innerText = isAtiva ? 'INATIVA' : 'ATIVA';
    btn.className = `px-6 py-2 rounded-lg text-[10px] font-bold transition-all ${!isAtiva ? 'bg-green-600' : 'bg-red-600'}`;
}

// Inicializa√ß√£o Correta
window.onload = () => {
    carregarEmpresa();
};
</script>
</body>
</html>
