<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marcinha Semijoias</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Cinzel:wght@400;700&display=swap');
body{font-family:'Inter',sans-serif;background:#F8F6F2}
.font-serif{font-family:'Cinzel',serif}
</style>
</head>

<body>

<header class="bg-white py-6 text-center border-b">
 <h1 class="font-serif text-2xl tracking-[0.3em] text-[#A68966]">Marcinha Semijoias</h1>
</header>

<main id="catalog" class="max-w-6xl mx-auto p-8 grid md:grid-cols-3 gap-6"></main>

<div class="fixed bottom-6 right-6">
 <button onclick="checkout()" class="bg-[#25D366] text-white px-6 py-3 rounded-full font-bold shadow-lg">
  Finalizar no WhatsApp
 </button>
</div>

<script>
const firebaseConfig={
 apiKey:"AIzaSyD5RdWTYOnaTov7VtM9ZGenUpFYSZVGoPs",
 authDomain:"marcinha-semijoias.firebaseapp.com",
 databaseURL:"https://marcinha-semijoias-default-rtdb.firebaseio.com",
 projectId:"marcinha-semijoias",
 storageBucket:"marcinha-semijoias.appspot.com",
 messagingSenderId:"830107812924",
 appId:"1:830107812924:web:1ee54d9b875514e48eef39"
};

if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let cart=[];

function addToCart(p){
 if(p.stock <= 0) return alert("Produto sem estoque");
 cart.push(p);
 alert("Produto adicionado");
}

function checkout(){
 if(!cart.length) return alert("Carrinho vazio");

 const name = prompt("Nome do cliente:");
 if(!name) return;

 db.ref('settings').once('value', s=>{
  const pixDiscount = s.val()?.pix || 0;

  let itemsText = "";
  let total = 0;

  cart.forEach(p=>{
   itemsText += `${p.name} (${p.sku}) - R$ ${p.price}\n`;
   total += p.price;
  });

  const discount = total * (pixDiscount / 100);
  const totalPix = total - discount;
  const date = new Date().toLocaleDateString('pt-BR');

  // ðŸ”¹ SALVAR PEDIDO
  const orderRef = db.ref('orders').push({
   customerName: name,
   items: itemsText,
   total: totalPix.toFixed(2),
   originalTotal: total.toFixed(2),
   payment: "PIX",
   date
  });

  // ðŸ”¹ BAIXAR ESTOQUE
  cart.forEach(p=>{
   db.ref('products').orderByChild('sku').equalTo(p.sku)
   .once('value', snap=>{
    snap.forEach(prod=>{
     const stock = prod.val().stock - 1;
     prod.ref.update({ stock });
    });
   });
  });

  // ðŸ”¹ WHATSAPP
  let msg = `*Pedido Marcinha Semijoias*%0A%0A`;
  msg += `Cliente: ${name}%0A%0A`;
  msg += itemsText.replace(/\n/g,'%0A');
  msg += `%0A*Total:* R$ ${total}`;
  msg += `%0A*PIX (${pixDiscount}% OFF):* R$ ${totalPix.toFixed(2)}`;

  window.open(`https://wa.me/55SEUNUMEROAQUI?text=${msg}`, "_blank");

  cart = [];
 });
}

db.ref('products').on('value', s=>{
 const catalog=document.getElementById('catalog');
 catalog.innerHTML='';
 if(!s.val()) return;

 Object.values(s.val()).forEach(p=>{
  catalog.innerHTML+=`
   <div class="bg-white border p-4">
    <img src="${p.image}" class="h-56 w-full object-cover mb-4">
    <h3 class="font-serif text-lg">${p.name}</h3>
    <p class="text-sm text-gray-500">${p.category}</p>
    <strong class="block mt-2 text-lg">R$ ${p.price}</strong>
    <p class="text-xs text-gray-400">Estoque: ${p.stock}</p>
    <button onclick='addToCart(${JSON.stringify(p)})'
     class="mt-3 w-full bg-black text-white text-xs py-2 uppercase">
     Adicionar
    </button>
   </div>`;
 });
});
</script>
