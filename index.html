<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Marcinha Semijoias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.font-serif{font-family:'Cinzel',serif}
.gold{color:#A68966}
</style>
</head>

<body>

<header class="bg-white p-8 border-b text-center">
  <h1 class="font-serif text-3xl tracking-widest gold">Marcinha Semijoias</h1>
  <p class="text-xs tracking-widest text-gray-400 mt-1">CAT√ÅLOGO EXCLUSIVO</p>
</header>

<main class="max-w-7xl mx-auto p-8 grid lg:grid-cols-3 gap-10">

<!-- PRODUTOS -->
<section class="lg:col-span-2 grid sm:grid-cols-2 gap-8" id="produtos"></section>

<!-- CARRINHO -->
<aside class="bg-white border p-6 space-y-6">

<h2 class="font-serif text-lg gold">Carrinho</h2>

<div class="space-y-2">
  <label class="text-xs tracking-widest">NOME DO CLIENTE</label>
  <input id="clienteNome" class="border p-2 w-full" placeholder="Digite seu nome">
</div>

<div id="carrinho" class="space-y-4"></div>

<hr>

<div class="text-sm space-y-1">
  <p>Subtotal: <strong>R$ <span id="subtotal">0.00</span></strong></p>
  <p id="descontoPix" class="text-green-600 hidden"></p>
  <p class="text-lg font-semibold">Total: R$ <span id="total">0.00</span></p>
</div>

<hr>

<div class="space-y-3">
<label class="flex items-center gap-2">
  <input type="radio" name="pagamento" value="PIX" checked>
  <span class="gold font-medium">PIX</span>
</label>

<label class="flex items-center gap-2">
  <input type="radio" name="pagamento" value="CARTAO">
  <span class="font-medium">Cart√£o</span>
</label>

<select id="parcelas" class="border p-2 w-full hidden">
  <option value="1x">1x sem juros</option>
  <option value="2x">2x sem juros</option>
  <option value="3x">3x sem juros</option>
</select>
</div>

<button onclick="finalizarPedido()" class="w-full bg-black text-white py-3 tracking-widest text-xs">
FINALIZAR NO WHATSAPP
</button>

</aside>
</main>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyD5RdWTYOnaTov7VtM9ZGenUpFYSZVGoPs",
  authDomain: "marcinha-semijoias.firebaseapp.com",
  databaseURL: "https://marcinha-semijoias-default-rtdb.firebaseio.com",
  projectId: "marcinha-semijoias"
});

const db = firebase.database();

/* üîß AJUSTE CR√çTICO (SEM MEXER EM NADA VISUAL) */
const produtosEl = document.getElementById('produtos');
const carrinhoEl = document.getElementById('carrinho');
const subtotalEl = document.getElementById('subtotal');
const totalEl = document.getElementById('total');
const descontoPix = document.getElementById('descontoPix');
const parcelas = document.getElementById('parcelas');
const clienteNome = document.getElementById('clienteNome');

let produtos = {};
let carrinho = [];
let config = {};

/* CONFIG */
db.ref('settings').once('value').then(s=>{
  config = s.val() || {};
});

/* PRODUTOS */
db.ref('products').on('value', snap=>{
  produtos = {};
  produtosEl.innerHTML = '';

  snap.forEach(s=>{
    const p = s.val();
    p.id = s.key;
    produtos[p.id] = p;

    produtosEl.innerHTML += `
    <div class="bg-white border p-4 space-y-3">
      <img src="${p.image}" class="w-full h-52 object-cover">
      <h3 class="font-serif">${p.name}</h3>
      <p class="text-xs text-gray-400 tracking-widest">SKU: ${p.sku || '-'}</p>
      <p class="gold text-lg font-semibold">R$ ${Number(p.price).toFixed(2)}</p>
      <button onclick="adicionar('${p.id}')" class="w-full border py-2 text-xs tracking-widest">
        ADICIONAR
      </button>
    </div>`;
  });
});

/* CARRINHO */
function adicionar(id){
  const item = carrinho.find(i=>i.id===id);
  if(item) item.qty++;
  else carrinho.push({id,qty:1});
  renderCarrinho();
}

function alterarQtd(id,delta){
  const item = carrinho.find(i=>i.id===id);
  item.qty += delta;
  if(item.qty<=0) carrinho = carrinho.filter(i=>i.id!==id);
  renderCarrinho();
}

function renderCarrinho(){
  carrinhoEl.innerHTML='';
  let subtotal=0;

  carrinho.forEach(i=>{
    const p = produtos[i.id];
    subtotal += Number(p.price) * i.qty;

    carrinhoEl.innerHTML += `
    <div class="border-b pb-3 flex justify-between items-start gap-4">
      <div class="flex-1">
        <p class="font-medium">${p.name}</p>
        <p class="text-xs text-gray-400">SKU: ${p.sku || '-'}</p>

        <div class="mt-2 inline-flex items-center border rounded">
          <button onclick="alterarQtd('${i.id}',-1)" class="px-3 py-1">‚ûñ</button>
          <span class="px-4 text-sm">${i.qty}</span>
          <button onclick="alterarQtd('${i.id}',1)" class="px-3 py-1">‚ûï</button>
        </div>
      </div>

      <div class="text-right font-medium">
        R$ ${(Number(p.price) * i.qty).toFixed(2)}
      </div>
    </div>`;
  });

  subtotalEl.textContent = subtotal.toFixed(2);

  let total=subtotal;
  descontoPix.classList.add('hidden');

  if(document.querySelector('[name=pagamento]:checked').value==='PIX'){
    const d = config.pix || 0;
    if(d>0){
      const desc = subtotal*(d/100);
      total = subtotal-desc;
      descontoPix.textContent = `Desconto PIX (${d}%): -R$ ${desc.toFixed(2)}`;
      descontoPix.classList.remove('hidden');
    }
  }

  totalEl.textContent = total.toFixed(2);
}

/* PAGAMENTO */
document.querySelectorAll('[name=pagamento]').forEach(r=>{
  r.onchange = ()=>{
    parcelas.classList.toggle('hidden', r.value!=='CARTAO');
    renderCarrinho();
  };
});

/* CHECKOUT */
function finalizarPedido(){
  if(carrinho.length===0) return alert('Carrinho vazio');

  const nome = clienteNome.value.trim();
  if(!nome) return alert('Informe seu nome');

  const pagamento = document.querySelector('[name=pagamento]:checked').value;
  const total = parseFloat(totalEl.textContent);

  const pedido = {
    cliente: nome,
    customer: nome,
    data: new Date().toLocaleString('pt-BR'),
    status: 'Novo',
    pagamento,
    parcelas: pagamento==='CARTAO' ? parcelas.value : '√Ä vista',
    total,
    itens: carrinho.map(i=>({
      nome: produtos[i.id].name,
      sku: produtos[i.id].sku,
      qtd: i.qty,
      valor: Number(produtos[i.id].price)
    }))
  };

  db.ref('orders').push(pedido);

  carrinho.forEach(i=>{
    db.ref('products/'+i.id+'/stock')
      .transaction(s=>s-i.qty);
  });

  let msg = `Ol√°! Pedido de *${nome}*:%0A%0A`;
  pedido.itens.forEach(i=>{
    msg += `${i.qtd}x ${i.nome} (SKU ${i.sku})%0A`;
  });
  msg += `%0ATotal: R$ ${total.toFixed(2)}%0APagamento: ${pedido.pagamento}`;

  window.open(`https://wa.me/55${config.whatsapp}?text=${msg}`);
}
</script>

</body>
</html>
