<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Marcinha Semijoias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.font-serif{font-family:'Cinzel',serif}
.gold{color:#A68966}
</style>
</head>

<body>

<header class="bg-white p-8 border-b text-center relative">
  <h1 class="font-serif text-3xl tracking-widest gold">Marcinha Semijoias</h1>
  <p class="text-xs tracking-widest text-gray-400 mt-1">CAT√ÅLOGO EXCLUSIVO</p>

  <!-- Bot√£o desktop carrinho -->
  <button id="btnCarrinhoDesktop" class="absolute top-5 right-10 hidden lg:inline-block bg-black text-white px-4 py-2 rounded text-xs tracking-widest">
    üõí Carrinho
  </button>
</header>

<main class="max-w-7xl mx-auto p-8 grid lg:grid-cols-3 gap-10">

<!-- PRODUTOS -->
<section class="lg:col-span-2 grid sm:grid-cols-2 gap-8" id="produtos"></section>

<!-- CARRINHO DESKTOP -->
<aside id="cartBox" class="bg-white border p-6 space-y-6 hidden lg:block">

<h2 class="font-serif text-lg gold">Carrinho</h2>

<div class="space-y-2">
  <label class="text-xs tracking-widest">NOME DO CLIENTE</label>
  <input id="clienteNome" class="border p-2 w-full" placeholder="Digite seu nome">
</div>

<div id="carrinho" class="space-y-4"></div>

<hr>

<div class="text-sm space-y-1">
  <p>Subtotal: <strong>R$ <span id="subtotal">0.00</span></strong></p>
  <p id="descontoPix" class="text-green-600 hidden"></p>
  <p class="text-lg font-semibold">Total: R$ <span id="total">0.00</span></p>
</div>

<hr>

<div class="space-y-3">
<label class="flex items-center gap-2">
  <input type="radio" name="pagamento" value="PIX" checked>
  <span class="gold font-medium">PIX</span>
</label>

<label class="flex items-center gap-2">
  <input type="radio" name="pagamento" value="CARTAO">
  <span class="font-medium">Cart√£o</span>
</label>

<select id="parcelas" class="border p-2 w-full hidden">
  <option value="1x">1x sem juros</option>
  <option value="2x">2x sem juros</option>
  <option value="3x">3x sem juros</option>
</select>
</div>

<button onclick="finalizarPedido()" class="w-full bg-black text-white py-3 tracking-widest text-xs">
FINALIZAR NO WHATSAPP
</button>

</aside>
</main>

<!-- BOT√ÉO FLUTUANTE MOBILE -->
<button 
  id="btnCarrinhoMobile"
  class="fixed bottom-5 right-5 bg-black text-white px-5 py-3 rounded-full text-xs tracking-widest lg:hidden shadow-lg z-50">
  üõí Carrinho
</button>

<!-- MODAL CARRINHO MOBILE -->
<div id="modalCarrinho" class="fixed inset-0 bg-black/50 hidden z-50 lg:hidden">
  <div class="bg-white w-11/12 max-w-md mx-auto mt-20 p-6 rounded shadow-lg relative">
    <button id="fecharModal" class="absolute top-2 right-2 text-black font-bold text-lg">‚úï</button>
    <h2 class="font-serif text-lg gold mb-4">Carrinho</h2>

    <div class="space-y-2">
      <label class="text-xs tracking-widest">NOME DO CLIENTE</label>
      <input id="clienteNomeMobile" class="border p-2 w-full" placeholder="Digite seu nome">
    </div>

    <div id="carrinhoMobile" class="space-y-4 max-h-80 overflow-y-auto mb-4"></div>

    <div class="text-sm space-y-1">
      <p>Subtotal: <strong>R$ <span id="subtotalMobile">0.00</span></strong></p>
      <p id="descontoPixMobile" class="text-green-600 hidden"></p>
      <p class="text-lg font-semibold">Total: R$ <span id="totalMobile">0.00</span></p>
    </div>

    <hr class="my-2">

    <div class="space-y-3">
      <label class="flex items-center gap-2">
        <input type="radio" name="pagamentoMobile" value="PIX" checked>
        <span class="gold font-medium">PIX</span>
      </label>

      <label class="flex items-center gap-2">
        <input type="radio" name="pagamentoMobile" value="CARTAO">
        <span class="font-medium">Cart√£o</span>
      </label>

      <select id="parcelasMobile" class="border p-2 w-full hidden">
        <option value="1x">1x sem juros</option>
        <option value="2x">2x sem juros</option>
        <option value="3x">3x sem juros</option>
      </select>
    </div>

    <button onclick="finalizarPedidoMobile()" class="w-full bg-black text-white py-3 tracking-widest text-xs mt-3">
      FINALIZAR NO WHATSAPP
    </button>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyD5RdWTYOnaTov7VtM9ZGenUpFYSZVGoPs",
  authDomain: "marcinha-semijoias.firebaseapp.com",
  databaseURL: "https://marcinha-semijoias-default-rtdb.firebaseio.com",
  projectId: "marcinha-semijoias"
});

const db = firebase.database();

const produtosEl = document.getElementById('produtos');
const carrinhoEl = document.getElementById('carrinho');
const subtotalEl = document.getElementById('subtotal');
const totalEl = document.getElementById('total');
const descontoPix = document.getElementById('descontoPix');
const parcelas = document.getElementById('parcelas');
const clienteNome = document.getElementById('clienteNome');
const cartBox = document.getElementById('cartBox');
const btnCarrinhoMobile = document.getElementById('btnCarrinhoMobile');
const btnCarrinhoDesktop = document.getElementById('btnCarrinhoDesktop');

// Modal mobile
const modalCarrinho = document.getElementById('modalCarrinho');
const carrinhoMobileEl = document.getElementById('carrinhoMobile');
const subtotalMobileEl = document.getElementById('subtotalMobile');
const totalMobileEl = document.getElementById('totalMobile');
const descontoPixMobile = document.getElementById('descontoPixMobile');
const parcelasMobile = document.getElementById('parcelasMobile');
const clienteNomeMobile = document.getElementById('clienteNomeMobile');
const fecharModal = document.getElementById('fecharModal');

let produtos = {};
let carrinho = [];
let config = {};

/* CONFIG */
db.ref('settings').once('value').then(s=>{
  config = s.val() || {};
});

/* PRODUTOS */
db.ref('products').on('value', snap=>{
  produtos = {};
  produtosEl.innerHTML = '';

  snap.forEach(s=>{
    const p = s.val();
    p.id = s.key;
    produtos[p.id] = p;

    produtosEl.innerHTML += `
    <div class="bg-white border p-4 space-y-3">
      <img src="${p.image}" class="w-full h-52 object-cover">
      <h3 class="font-serif">${p.name}</h3>
      <p class="text-xs text-gray-400 tracking-widest">SKU: ${p.sku || '-'}</p>
      <p class="gold text-lg font-semibold">R$ ${Number(p.price).toFixed(2)}</p>
      <button data-id="${p.id}" class="w-full border py-2 text-xs tracking-widest btn-adicionar">
        ADICIONAR
      </button>
    </div>`;
  });

  document.querySelectorAll('.btn-adicionar').forEach(btn=>{
    btn.addEventListener('click', function(){
      const id = this.dataset.id;
      adicionar(id);
    });
  });
});

/* CARRINHO FUNCIONAL */
function adicionar(id){
  const item = carrinho.find(i=>i.id===id);
  if(item) item.qty++;
  else carrinho.push({id,qty:1});
  renderCarrinho();
}

function alterarQtd(id,delta){
  const item = carrinho.find(i=>i.id===id);
  item.qty += delta;
  if(item.qty<=0) carrinho = carrinho.filter(i=>i.id!==id);
  renderCarrinho();
}

function renderCarrinho(){
  // Desktop
  carrinhoEl.innerHTML='';
  let subtotal=0;

  carrinho.forEach(i=>{
    const p = produtos[i.id];
    subtotal += Number(p.price) * i.qty;

    carrinhoEl.innerHTML += `
    <div class="border-b pb-3 flex gap-4 items-start">

      <img src="${p.image}" class="w-16 h-16 object-cover rounded border">

      <div class="flex-1">
        <p class="font-medium leading-tight">${p.name}</p>
        <p class="text-xs text-gray-400">SKU: ${p.sku || '-'}</p>

        <div class="mt-2 inline-flex items-center border rounded">
          <button onclick="alterarQtd('${i.id}',-1)" class="px-3 py-1">‚ûñ</button>
          <span class="px-4 text-sm">${i.qty}</span>
          <button onclick="alterarQtd('${i.id}',1)" class="px-3 py-1">‚ûï</button>
        </div>
      </div>

      <div class="text-right font-medium whitespace-nowrap">
        R$ ${(Number(p.price) * i.qty).toFixed(2)}
      </div>
    </div>`;
  });

  subtotalEl.textContent = subtotal.toFixed(2);
  totalEl.textContent = calcularTotal(subtotal, descontoPix);
  
  // Mobile
  carrinhoMobileEl.innerHTML='';
  let subtotalMobile = 0;
  carrinho.forEach(i=>{
    const p = produtos[i.id];
    subtotalMobile += Number(p.price) * i.qty;

    carrinhoMobileEl.innerHTML += `
    <div class="border-b pb-3 flex gap-4 items-start">

      <img src="${p.image}" class="w-16 h-16 object-cover rounded border">

      <div class="flex-1">
        <p class="font-medium leading-tight">${p.name}</p>
        <p class="text-xs text-gray-400">SKU: ${p.sku || '-'}</p>

        <div class="mt-2 inline-flex items-center border rounded">
          <button onclick="alterarQtd('${i.id}',-1)" class="px-3 py-1">‚ûñ</button>
          <span class="px-4 text-sm">${i.qty}</span>
          <button onclick="alterarQtd('${i.id}',1)" class="px-3 py-1">‚ûï</button>
        </div>
      </div>

      <div class="text-right font-medium whitespace-nowrap">
        R$ ${(Number(p.price) * i.qty).toFixed(2)}
      </div>
    </div>`;
  });

  subtotalMobileEl.textContent = subtotalMobile.toFixed(2);
  totalMobileEl.textContent = calcularTotal(subtotalMobile, descontoPixMobile, true);
}

function calcularTotal(sub, descontoEl, mobile=false){
  descontoEl.classList.add('hidden');
  let total = sub;
  const name = mobile ? 'pagamentoMobile' : 'pagamento';
  if(document.querySelector(`[name=${name}]:checked`).value==='PIX'){
    const d = config.pix || 0;
    if(d>0){
      const desc = sub*(d/100);
      total = sub - desc;
      descontoEl.textContent = `Desconto PIX (${d}%): -R$ ${desc.toFixed(2)}`;
      descontoEl.classList.remove('hidden');
    }
  }
  return total.toFixed(2);
}

/* PAGAMENTO */
document.querySelectorAll('[name=pagamento]').forEach(r=>{
  r.onchange = ()=> renderCarrinho();
});
document.querySelectorAll('[name=pagamentoMobile]').forEach(r=>{
  r.onchange = ()=> renderCarrinho();
});
document.getElementById('parcelasMobile').classList.add('hidden');
document.querySelectorAll('[name=pagamentoMobile]').forEach(r=>{
  r.onchange = ()=>{
    parcelasMobile.classList.toggle('hidden', r.value!=='CARTAO');
    renderCarrinho();
  };
});

/* CHECKOUT */
function finalizarPedido(){
  checkout(carrinho, clienteNome, totalEl);
}
function finalizarPedidoMobile(){
  checkout(carrinho, clienteNomeMobile, totalMobileEl);
}

function checkout(carrinhoArr, nomeInput, totalElement){
  if(carrinhoArr.length===0) return alert('Carrinho vazio');
  const nome = nomeInput.value.trim();
  if(!nome) return alert('Informe seu nome');

  const pagamento = document.querySelector(`[name=${nomeInput===clienteNome?'pagamento':'pagamentoMobile'}]:checked`).value;
  const total = parseFloat(totalElement.textContent);

  const pedido = {
    cliente: nome,
    customer: nome,
    data: new Date().toLocaleString('pt-BR'),
    status: 'Novo',
    pagamento,
    parcelas: pagamento==='CARTAO' ? (nomeInput===clienteNome? parcelas.value : parcelasMobile.value) : '√Ä vista',
    total,
    itens: carrinhoArr.map(i=>({
      nome: produtos[i.id].name,
      sku: produtos[i.id].sku,
      qtd: i.qty,
      valor: Number(produtos[i.id].price)
    }))
  };

  db.ref('orders').push(pedido);

  carrinhoArr.forEach(i=>{
    db.ref('products/'+i.id+'/stock')
      .transaction(s=>s-i.qty);
  });

  let msg = `Ol√°! Pedido de *${nome}*:%0A%0A`;
  pedido.itens.forEach(i=>{
    msg += `${i.qtd}x ${i.nome} (SKU ${i.sku})%0A`;
  });
  msg += `%0ATotal: R$ ${total.toFixed(2)}%0APagamento: ${pedido.pagamento}`;

  window.open(`https://wa.me/55${config.whatsapp}?text=${msg}`);
}

/* MOBILE MODAL */
btnCarrinhoMobile.addEventListener('click', ()=>{
  modalCarrinho.classList.remove('hidden');
});
fecharModal.addEventListener('click', ()=>{
  modalCarrinho.classList.add('hidden');
});

/* DESKTOP */
btnCarrinhoDesktop.addEventListener('click', ()=>{
  cartBox.classList.toggle('hidden');
});
</script>

</body>
</html>

