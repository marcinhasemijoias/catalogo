<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Joias - Coleção Exclusiva</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #FDFBF7; color: #2D2926; overflow-x: hidden; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .lux-border { border-color: #E5DACE; }
        .lux-gold { color: #A68966; }
        .cart-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); position: fixed; inset: 0; z-index: 50; }
        .payment-btn-active { border: 2px solid #A68966 !important; background: #FDFBF7; color: #A68966; font-weight: 800; }
        input:focus { border-bottom-color: #A68966 !important; outline: none; }
        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #E5DACE; }
    </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

const Icon = ({ name, size = 18 }) => {
    useEffect(() => { window.lucide && window.lucide.createIcons(); }, [name]);
    return <i data-lucide={name} style={{ width: size, height: size }}></i>;
};

function App() {
    const [products, setProducts] = useState([]);
    const [storeConfig, setStoreConfig] = useState({
        name: 'Royal Joias',
        whatsapp: '',
        pixDiscount: 10,
        maxInstallments: 12
    });

    const [cart, setCart] = useState([]);
    const [isCartOpen, setIsCartOpen] = useState(false);
    const [paymentMethod, setPaymentMethod] = useState('pix');
    const [selectedInstallment, setSelectedInstallment] = useState(1);
    const [customer, setCustomer] = useState({ name: '', phone: '' });
    const [orderStep, setOrderStep] = useState('cart');
    const [isSending, setIsSending] = useState(false);

    useEffect(() => {
        const savedProducts = localStorage.getItem('luxury_products');
        const savedConfig = localStorage.getItem('luxury_config');
        if (savedProducts) setProducts(JSON.parse(savedProducts));
        if (savedConfig) setStoreConfig(JSON.parse(savedConfig));
    }, []);

    const formatMoney = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    const totalBase = cart.reduce((acc, item) => acc + (parseFloat(item.price) * (item.quantity || 1)), 0);
    const totalPix = totalBase * (1 - storeConfig.pixDiscount / 100);
    const valorFinal = paymentMethod === 'pix' ? totalPix : totalBase;

    const addToCart = (p) => {
        const exists = cart.find(i => i.id === p.id);
        if(exists){
            setCart(cart.map(i => i.id === p.id ? {...i, quantity: (i.quantity || 1) + 1} : i));
        } else {
            setCart([...cart, {...p, quantity: 1}]);
        }
        setIsCartOpen(true);
        setOrderStep('cart');
    };

    const updateQty = (id, delta) => {
        setCart(cart.map(i => i.id === id ? {...i, quantity: Math.max(1, (i.quantity || 1) + delta)} : i));
    };

    const removeItem = id => setCart(cart.filter(i => i.id !== id));

    const maskPhone = v => {
        let r = v.replace(/\D/g, "").substring(0, 11);
        if (r.length > 10) r = r.replace(/^(\d{2})(\d{5})(\d{4}).*/, "($1) $2-$3");
        else if (r.length > 5) r = r.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
        else if (r.length > 2) r = r.replace(/^(\d{2})(\d{0,5})/, "($1) $2");
        return r;
    };

    // FUNÇÃO DE FINALIZAÇÃO CORRIGIDA
    const handleFinalize = () => {
        if (isSending) return;

        const cleanPhoneStore = storeConfig.whatsapp.replace(/\D/g, '');
        const cleanPhoneCustomer = customer.phone.replace(/\D/g, '');

        if (!customer.name || cleanPhoneCustomer.length < 10) {
            alert("Por favor, preencha seu nome e telefone corretamente.");
            return;
        }

        setIsSending(true);

        const orderData = {
            id: 'ORD-' + Date.now(),
            date: new Date().toLocaleString('pt-BR'),
            customer: {
                name: customer.name,
                phone: customer.phone
            },
            items: cart,
            paymentMethod: paymentMethod === 'pix' ? 'PIX' : `${selectedInstallment}x no Cartão`,
            total: valorFinal
        };

        // Salva para o Admin ver
        const savedOrders = JSON.parse(localStorage.getItem('luxury_orders') || '[]');
        localStorage.setItem('luxury_orders', JSON.stringify([orderData, ...savedOrders]));

        // Monta Mensagem WhatsApp
        const itemText = cart.map(i => `• ${i.quantity}x ${i.name}`).join('\n');
        const msg = `*PEDIDO: ${storeConfig.name}*\n\n` +
                    `*Cliente:* ${customer.name}\n` +
                    `*Itens:*\n${itemText}\n\n` +
                    `*Pagamento:* ${orderData.paymentMethod}\n` +
                    `*Total:* ${formatMoney(valorFinal)}\n\n` +
                    `Aguardando confirmação!`;

        // Abre o WhatsApp
        window.open(`https://wa.me/${cleanPhoneStore}?text=${encodeURIComponent(msg)}`, '_blank');

        // Limpa e finaliza
        setTimeout(() => {
            setCart([]);
            setOrderStep('success');
            setIsSending(false);
        }, 800);
    };

    return (
        <div className="min-h-screen">
            <header className="bg-white border-b lux-border py-6 px-6 sticky top-0 z-40 flex justify-between items-center">
                <div className="w-6"></div>
                <h1 className="font-serif tracking-[0.4em] uppercase text-xl">{storeConfig.name}</h1>
                <button onClick={() => setIsCartOpen(true)} className="relative">
                    <Icon name="shopping-bag" size={24} />
                    {cart.length > 0 && <span className="absolute -top-2 -right-2 bg-black text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center">{cart.length}</span>}
                </button>
            </header>

            <main className="max-w-5xl mx-auto px-6 py-12 grid md:grid-cols-2 gap-12">
                {products.map(p => (
                    <div key={p.id} className="text-center border-b lux-border pb-8">
                        <img src={p.image} className="w-full aspect-square object-cover mb-4 border" />
                        <h3 className="font-serif uppercase tracking-widest text-lg">{p.name}</h3>
                        <p className="lux-gold font-bold mt-2">{formatMoney(p.price * (1 - storeConfig.pixDiscount/100))} <span className="text-xs text-gray-400 font-normal underline">no PIX</span></p>
                        <button onClick={() => addToCart(p)} className="mt-4 bg-[#2D2926] text-white py-3 w-full text-[10px] uppercase tracking-widest font-bold">Adicionar à Sacola</button>
                    </div>
                ))}
            </main>

            {isCartOpen && (
                <div className="fixed inset-0 z-50 flex justify-end">
                    <div className="cart-overlay" onClick={() => orderStep !== 'success' && setIsCartOpen(false)}></div>
                    <div className="relative w-full max-w-md bg-white h-full p-8 flex flex-col shadow-2xl">
                        
                        <div className="flex justify-between items-center mb-8 border-b pb-4">
                            <h2 className="font-serif text-xl uppercase tracking-widest">
                                {orderStep === 'cart' ? 'Sacola' : orderStep === 'checkout' ? 'Identificação' : 'Pedido Enviado'}
                            </h2>
                            <button onClick={() => setIsCartOpen(false)}><Icon name="x" size={24} /></button>
                        </div>

                        {orderStep === 'cart' && (
                            <div className="flex-grow flex flex-col overflow-hidden">
                                <div className="flex-grow overflow-y-auto space-y-4 custom-scroll pr-2">
                                    {cart.map(item => (
                                        <div key={item.id} className="flex gap-4 items-center border-b lux-border pb-4">
                                            <img src={item.image} className="w-16 h-16 object-cover" />
                                            <div className="flex-grow">
                                                <p className="text-[10px] font-bold uppercase">{item.name}</p>
                                                <div className="flex items-center gap-2 mt-2">
                                                    <button onClick={() => updateQty(item.id, -1)} className="border px-2">-</button>
                                                    <span className="text-xs">{item.quantity}</span>
                                                    <button onClick={() => updateQty(item.id, 1)} className="border px-2">+</button>
                                                    <button onClick={() => removeItem(item.id)} className="ml-4 text-red-300"><Icon name="trash-2" size={14}/></button>
                                                </div>
                                            </div>
                                            <p className="text-xs font-bold">{formatMoney(item.price * item.quantity)}</p>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-6 space-y-4 border-t pt-4">
                                    <div className="flex justify-between font-serif text-lg">
                                        <span>Total</span>
                                        <span className="lux-gold">{formatMoney(valorFinal)}</span>
                                    </div>
                                    <button onClick={() => setOrderStep('checkout')} className="w-full bg-black text-white py-4 text-[10px] font-bold uppercase tracking-widest">Finalizar Pedido</button>
                                </div>
                            </div>
                        )}

                        {orderStep === 'checkout' && (
                            <div className="space-y-6">
                                <input className="w-full border-b py-3 outline-none" placeholder="Seu Nome" onChange={e => setCustomer({...customer, name: e.target.value})} />
                                <input className="w-full border-b py-3 outline-none" placeholder="Seu WhatsApp" value={customer.phone} onChange={e => setCustomer({...customer, phone: maskPhone(e.target.value)})} />
                                
                                <div className="pt-4">
                                    <p className="text-[10px] font-bold uppercase text-gray-400 mb-2">Forma de Pagamento</p>
                                    <div className="grid grid-cols-2 gap-2 mb-4">
                                        <button onClick={() => setPaymentMethod('pix')} className={`py-3 border text-[10px] font-bold uppercase ${paymentMethod==='pix'?'payment-btn-active':'text-gray-400'}`}>PIX</button>
                                        <button onClick={() => setPaymentMethod('card')} className={`py-3 border text-[10px] font-bold uppercase ${paymentMethod==='card'?'payment-btn-active':'text-gray-400'}`}>Cartão</button>
                                    </div>
                                    
                                    {paymentMethod === 'card' && (
                                        <select className="w-full border p-2 text-xs" onChange={e => setSelectedInstallment(e.target.value)}>
                                            {[...Array(storeConfig.maxInstallments)].map((_,i) => (
                                                <option key={i} value={i+1}>{i+1}x de {formatMoney(totalBase/(i+1))}</option>
                                            ))}
                                        </select>
                                    )}
                                </div>

                                <button onClick={handleFinalize} disabled={isSending} className="w-full bg-[#2D2926] text-white py-5 text-[10px] font-bold uppercase tracking-widest mt-8">
                                    {isSending ? 'Processando...' : 'Confirmar via WhatsApp'}
                                </button>
                                <button onClick={() => setOrderStep('cart')} className="w-full text-[10px] uppercase text-gray-400 font-bold">Voltar</button>
                            </div>
                        )}

                        {orderStep === 'success' && (
                            <div className="flex flex-col items-center justify-center h-full text-center">
                                <Icon name="check-circle" size={48} className="text-green-500 mb-4" />
                                <h2 className="font-serif text-xl mb-2">PEDIDO ENVIADO!</h2>
                                <p className="text-xs text-gray-400 mb-8 uppercase tracking-widest">Verifique seu WhatsApp para concluir o pagamento.</p>
                                <button onClick={() => setIsCartOpen(false)} className="border border-black px-8 py-3 text-[10px] font-bold uppercase tracking-widest">Fechar</button>
                            </div>
                        )}

                    </div>
                </div>
            )}
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
