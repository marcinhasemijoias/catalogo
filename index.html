<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Marcinha Semijoias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.font-serif{font-family:'Cinzel',serif}
.gold{color:#A68966}
</style>
</head>

<body>

<header class="bg-white border-b px-8 py-6 text-center">
  <h1 class="font-serif text-3xl gold tracking-widest">Marcinha Semijoias</h1>
  <p class="text-xs tracking-widest text-gray-400 uppercase mt-1">
    CatÃ¡logo Exclusivo
  </p>
</header>

<main class="max-w-7xl mx-auto p-8 grid md:grid-cols-4 gap-10">

<!-- CATÃLOGO -->
<section class="md:col-span-3">
  <div id="produtos" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-10"></div>
</section>

<!-- CARRINHO -->
<aside class="bg-white border p-6 space-y-6 sticky top-6 h-fit">
  <h2 class="font-serif text-xl gold">Carrinho</h2>

  <div id="carrinho" class="space-y-4 text-sm"></div>

  <div class="border-t pt-4 space-y-3 text-sm">
    <p>Subtotal: <strong id="subtotal">R$ 0,00</strong></p>
    <p id="pixLinha" class="text-green-700 hidden"></p>
    <p class="text-lg">Total: <strong id="total">R$ 0,00</strong></p>

    <!-- PAGAMENTO -->
    <div class="space-y-2 pt-2">
      <label class="flex items-center gap-2">
        <input type="radio" name="pagamento" value="PIX" checked>
        <span class="text-green-700 font-semibold">ðŸ’° PIX</span>
      </label>

      <label class="flex items-center gap-2">
        <input type="radio" name="pagamento" value="CARTAO">
        <span class="font-semibold">ðŸ’³ CartÃ£o</span>
      </label>

      <select id="parcelas" class="border p-2 w-full hidden text-sm"></select>
      <p id="parcelamentoInfo" class="text-xs text-gray-500"></p>
    </div>

    <button onclick="finalizarPedido()" class="bg-black text-white w-full py-3 tracking-widest text-xs uppercase">
      Finalizar no WhatsApp
    </button>
  </div>
</aside>

</main>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyD5RdWTYOnaTov7VtM9ZGenUpFYSZVGoPs",
 databaseURL:"https://marcinha-semijoias-default-rtdb.firebaseio.com",
 projectId:"marcinha-semijoias"
});

const db = firebase.database();

let produtos = {};
let carrinho = [];
let settings = {};
let pagamento = 'PIX';

/* ELEMENTOS */
const produtosEl = document.getElementById('produtos');
const carrinhoEl = document.getElementById('carrinho');

/* SETTINGS */
db.ref('settings').once('value').then(s=>{
 settings = s.val() || {};
 for(let i=1;i<=settings.parcelas;i++){
  parcelas.innerHTML+=`<option value="${i}">${i}x sem juros</option>`;
 }
});

/* PRODUTOS */
db.ref('products').on('value',snap=>{
 produtos = snap.val() || {};
 renderProdutos();
});

function renderProdutos(){
 produtosEl.innerHTML='';
 Object.entries(produtos).forEach(([id,p])=>{
  const pixPrice = settings.pix ? (p.price * (1 - settings.pix/100)) : p.price;
  produtosEl.innerHTML+=`
  <div class="bg-white border p-4 space-y-3">
    <img src="${p.image}" class="h-56 w-full object-cover">
    <h3 class="font-serif">${p.name}</h3>

    <p class="gold text-lg font-semibold">R$ ${p.price.toFixed(2)}</p>
    ${settings.pix ? `<p class="text-green-700 text-sm">PIX: R$ ${pixPrice.toFixed(2)}</p>` : ''}

    <button onclick="addCarrinho('${id}')" class="border w-full py-2 text-xs tracking-widest uppercase">
      Adicionar ao carrinho
    </button>
  </div>`;
 });
}

/* CARRINHO */
function addCarrinho(id){
 const item = carrinho.find(i=>i.id===id);
 if(item) item.qty++;
 else carrinho.push({id,qty:1});
 renderCarrinho();
}

function alterarQtd(id,delta){
 const item = carrinho.find(i=>i.id===id);
 item.qty += delta;
 if(item.qty<=0) carrinho = carrinho.filter(i=>i.id!==id);
 renderCarrinho();
}

function renderCarrinho(){
 carrinhoEl.innerHTML='';
 let subtotal = 0;

 carrinho.forEach(i=>{
  const p = produtos[i.id];
  subtotal += p.price * i.qty;
  carrinhoEl.innerHTML+=`
  <div class="flex justify-between items-center">
    <div>
      ${i.qty}x ${p.name}
      <div class="flex gap-2 text-xs mt-1">
        <button onclick="alterarQtd('${i.id}',-1)">âž–</button>
        <button onclick="alterarQtd('${i.id}',1)">âž•</button>
      </div>
    </div>
    <span>R$ ${(p.price*i.qty).toFixed(2)}</span>
  </div>`;
 });

 document.getElementById('subtotal').innerText = `R$ ${subtotal.toFixed(2)}`;

 let total = subtotal;
 pixLinha.classList.add('hidden');

 if(pagamento==='PIX' && settings.pix){
  const desconto = subtotal * (settings.pix/100);
  total -= desconto;
  pixLinha.innerText = `Desconto PIX (${settings.pix}%): -R$ ${desconto.toFixed(2)}`;
  pixLinha.classList.remove('hidden');
 }

 if(pagamento==='CARTAO'){
  const p = parcelas.value || 1;
  parcelamentoInfo.innerText = `${p}x de R$ ${(total/p).toFixed(2)}`;
 } else {
  parcelamentoInfo.innerText = '';
 }

 document.getElementById('total').innerText = `R$ ${total.toFixed(2)}`;
}

/* PAGAMENTO */
document.querySelectorAll('input[name=pagamento]').forEach(r=>{
 r.onchange=e=>{
  pagamento=e.target.value;
  parcelas.classList.toggle('hidden', pagamento!=='CARTAO');
  renderCarrinho();
 };
});

parcelas.onchange = renderCarrinho;

/* FINALIZAR */
function finalizarPedido(){
 if(carrinho.length===0) return alert('Carrinho vazio');

 const total = document.getElementById('total').innerText.replace('R$ ','');
 const pedido = {
  data: new Date().toLocaleString('pt-BR'),
  status: 'Novo',
  pagamento,
  parcelas: pagamento==='CARTAO' ? parcelas.value : 'Ã€ vista',
  total: parseFloat(total.replace(',','.')),
  itens: carrinho.map(i=>({
    id:i.id,
    nome:produtos[i.id].name,
    qtd:i.qty,
    valor:produtos[i.id].price
  }))
 };

 db.ref('orders').push(pedido);

 carrinho.forEach(i=>{
  db.ref('products/'+i.id+'/stock')
   .transaction(s=>(s||0)-i.qty);
 });

 let msg = `ðŸ›ï¸ *Novo Pedido*%0A%0A`;
 pedido.itens.forEach(i=>{
  msg+=`${i.qtd}x ${i.nome}%0A`;
 });
 msg+=`%0APagamento: ${pedido.pagamento}`;
 if(pagamento==='CARTAO') msg+=`%0AParcelas: ${pedido.parcelas}`;
 msg+=`%0ATotal: R$ ${pedido.total.toFixed(2)}`;

 window.open(`https://wa.me/55${settings.whatsapp}?text=${msg}`);

 carrinho=[];
 renderCarrinho();
 alert('Pedido enviado com sucesso!');
}
</script>

</body>
</html>


