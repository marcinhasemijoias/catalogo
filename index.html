<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo | Marcinha Semijoias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #FDFBF7; }
    </style>
</head>
<body>

    <header class="py-10 text-center border-b bg-white">
        <h1 class="font-serif text-3xl uppercase tracking-[0.2em] text-[#A68966]">Marcinha Semijoias</h1>
        <p class="text-[10px] uppercase tracking-widest text-gray-400 mt-2">Luxo e Sofisticação</p>
    </header>

    <main id="catalog-container" class="max-w-6xl mx-auto p-6 space-y-12">
        <p class="text-center text-gray-400 py-20">Carregando catálogo...</p>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD5RdWTYOnaTov7VtM9ZGenUpFYSZVGoPs",
            authDomain: "marcinha-semijoias.firebaseapp.com",
            databaseURL: "https://marcinha-semijoias-default-rtdb.firebaseio.com",
            projectId: "marcinha-semijoias",
            storageBucket: "marcinha-semijoias.firebasestorage.app",
            messagingSenderId: "830107812924",
            appId: "1:830107812924:web:1ee54d9b875514e48eef39"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Variáveis de configuração globais
        let pixDiscount = 0;
        let maxInstallments = 1;

        // 1. Primeiro, buscar as configurações da loja
        db.ref('settings').on('value', snapshot => {
            const settings = snapshot.val();
            if (settings) {
                pixDiscount = parseFloat(settings.pixDiscount) || 0;
                maxInstallments = parseInt(settings.installments) || 1;
            }
            renderCatalog(); // Re-renderiza quando as configs mudam
        });

        // 2. Buscar produtos e renderizar
        function renderCatalog() {
            db.ref('products').on('value', snapshot => {
                const data = snapshot.val();
                const container = document.getElementById('catalog-container');
                container.innerHTML = "";

                if (!data) {
                    container.innerHTML = "<p class='text-center'>Nenhum produto cadastrado.</p>";
                    return;
                }

                const categories = {};
                Object.values(data).forEach(p => {
                    if (!categories[p.category]) categories[p.category] = [];
                    categories[p.category].push(p);
                });

                Object.keys(categories).forEach(catName => {
                    const section = document.createElement('section');
                    section.innerHTML = `
                        <h2 class="font-serif text-sm uppercase tracking-widest text-[#A68966] mb-8 border-b pb-2">${catName}</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-10">
                            ${categories[catName].map(p => {
                                // Cálculos de preço
                                const pricePix = p.price * (1 - (pixDiscount / 100));
                                const installmentValue = p.price / maxInstallments;

                                return `
                                    <div class="group">
                                        <div class="relative overflow-hidden bg-gray-100 aspect-[3/4]">
                                            <img src="${p.image}" class="w-full h-full object-cover">
                                        </div>
                                        <div class="mt-4 text-center">
                                            <p class="text-[8px] text-gray-400 uppercase font-mono">${p.sku}</p>
                                            <h3 class="text-[10px] font-bold uppercase tracking-tight mt-1 h-8 overflow-hidden px-2">${p.name}</h3>
                                            
                                            <div class="mt-2">
                                                <p class="text-xs font-bold">R$ ${p.price.toFixed(2)}</p>
                                                <p class="text-[9px] text-green-600 font-bold uppercase mt-1">R$ ${pricePix.toFixed(2)} NO PIX</p>
                                                <p class="text-[9px] text-gray-400 uppercase mt-0.5">${maxInstallments}X DE R$ ${installmentValue.toFixed(2)}</p>
                                            </div>

                                            <button class="mt-4 w-full border border-black py-2 text-[9px] uppercase font-bold hover:bg-black hover:text-white transition">Adicionar</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                });
            });
        }
    </script>
</body>
</html>
