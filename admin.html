<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Administrativo | Abella Joias</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { background:#FDFBF7 }
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const { jsPDF } = window.jspdf;

/* ================== APP ================== */
function App() {

  /* EMPRESA */
  const [config, setConfig] = useState({
    name: "Abella Joias",
    whatsapp: "5599999999999",
    pixDiscount: 10
  });

  /* PRODUTOS */
  const [products, setProducts] = useState([]);
  const [editing, setEditing] = useState(null);

  /* VENDAS */
  const [orders, setOrders] = useState([]);

  /* LOAD */
  useEffect(() => {
    setProducts(JSON.parse(localStorage.getItem("products") || "[]"));
    setOrders(JSON.parse(localStorage.getItem("orders") || "[]"));

    const savedConfig = JSON.parse(localStorage.getItem("storeConfig"));
    if (savedConfig) setConfig(savedConfig);
  }, []);

  /* SAVE */
  function saveConfig() {
    localStorage.setItem("storeConfig", JSON.stringify(config));
    alert("Configurações salvas");
  }

  function saveProduct(p) {
    let list = [...products];

    if (p.id) {
      list = list.map(i => i.id === p.id ? p : i);
    } else {
      p.id = Date.now();
      list.push(p);
    }

    setProducts(list);
    localStorage.setItem("products", JSON.stringify(list));
    setEditing(null);
  }

  function deleteProduct(id) {
    if (!confirm("Excluir produto?")) return;
    const list = products.filter(p => p.id !== id);
    setProducts(list);
    localStorage.setItem("products", JSON.stringify(list));
  }

  function deleteOrder(id) {
    if (!confirm("Excluir pedido?")) return;
    const list = orders.filter(o => o.id !== id);
    setOrders(list);
    localStorage.setItem("orders", JSON.stringify(list));
  }

  function sendWhats(order) {
    const items = order.items.map(i => `• ${i.qty}x ${i.name}`).join("%0A");
    const msg = `Pedido #${order.id}%0ACliente: ${order.customer.name}%0A%0A${items}%0ATotal: ${order.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}`;
    window.open(`https://wa.me/${config.whatsapp}?text=${msg}`);
  }

  function pdf(order) {
    const doc = new jsPDF();
    doc.setFont("helvetica","bold");
    doc.text(config.name, 20, 20);

    doc.setFontSize(10);
    doc.text(`Pedido #${order.id}`, 20, 30);
    doc.text(`Cliente: ${order.customer.name}`, 20, 38);
    doc.text(`Pagamento: ${order.payment}`, 20, 46);

    let y = 60;
    order.items.forEach(i => {
      doc.text(`${i.qty}x ${i.name} (${i.sku || ""})`, 20, y);
      y += 8;
    });

    doc.text(`Total: ${order.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}`, 20, y+10);
    doc.save(`romaneio-${order.id}.pdf`);
  }

  return (
    <div className="max-w-7xl mx-auto p-8 space-y-16">

      <h1 className="text-3xl font-serif">Painel Administrativo</h1>

      {/* CONFIG */}
      <section className="bg-white p-6 shadow">
        <h2 className="font-serif text-xl mb-4">Empresa</h2>
        <div className="grid md:grid-cols-3 gap-4">
          <input className="border p-3" value={config.name} onChange={e=>setConfig({...config,name:e.target.value})} placeholder="Nome" />
          <input className="border p-3" value={config.whatsapp} onChange={e=>setConfig({...config,whatsapp:e.target.value})} placeholder="WhatsApp" />
          <input className="border p-3" type="number" value={config.pixDiscount} onChange={e=>setConfig({...config,pixDiscount:e.target.value})} placeholder="% PIX" />
        </div>
        <button onClick={saveConfig} className="mt-4 bg-black text-white px-6 py-3">Salvar</button>
      </section>

      {/* PRODUTOS */}
      <section className="bg-white p-6 shadow">
        <h2 className="font-serif text-xl mb-6">Produtos</h2>

        <ProductForm onSave={saveProduct} editing={editing} />

        <div className="grid md:grid-cols-2 gap-6 mt-8">
          {products.map(p=>(
            <div key={p.id} className="border p-4 flex gap-4">
              {p.image && <img src={p.image} className="w-20 h-24 object-contain bg-gray-50" />}
              <div className="flex-1">
                <p className="font-serif">{p.name}</p>
                <p className="text-xs text-gray-500">SKU: {p.sku}</p>
                <p>{p.price.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</p>
              </div>
              <div className="space-y-2">
                <button onClick={()=>setEditing(p)} className="text-xs underline">Editar</button>
                <button onClick={()=>deleteProduct(p.id)} className="text-xs text-red-500">Excluir</button>
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* VENDAS */}
      <section className="bg-white p-6 shadow">
        <h2 className="font-serif text-xl mb-6">Relatório de Vendas</h2>

        <div className="space-y-4">
          {orders.map(o=>(
            <div key={o.id} className="border p-4 flex justify-between items-center">
              <div>
                <p className="font-serif">Pedido #{o.id}</p>
                <p className="text-xs">{o.customer.name}</p>
              </div>
              <div className="flex gap-3">
                <button onClick={()=>pdf(o)} className="text-xs underline">PDF</button>
                <button onClick={()=>sendWhats(o)} className="text-xs underline">WhatsApp</button>
                <button onClick={()=>deleteOrder(o.id)} className="text-xs text-red-500">Excluir</button>
              </div>
            </div>
          ))}
        </div>
      </section>

    </div>
  );
}

/* FORM PRODUTO */
function ProductForm({ onSave, editing }) {
  const [p, setP] = useState(editing || { name:"", sku:"", price:"", image:"" });

  useEffect(()=>{ if(editing) setP(editing) },[editing]);

  function img(e){
    const r = new FileReader();
    r.onload = ev => setP({...p,image:ev.target.result});
    r.readAsDataURL(e.target.files[0]);
  }

  return (
    <div className="grid md:grid-cols-4 gap-4">
      <input className="border p-3" placeholder="Nome" value={p.name} onChange={e=>setP({...p,name:e.target.value})} />
      <input className="border p-3" placeholder="SKU" value={p.sku} onChange={e=>setP({...p,sku:e.target.value})} />
      <input className="border p-3" placeholder="Preço" type="number" value={p.price} onChange={e=>setP({...p,price:+e.target.value})} />
      <input type="file" onChange={img} />
      <button onClick={()=>onSave(p)} className="bg-black text-white py-3 col-span-full">
        {editing ? "Atualizar" : "Cadastrar"}
      </button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
